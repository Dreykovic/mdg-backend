generator client {
  provider = "prisma-client-js"
}

generator typescriptInterfaces {
  provider = "prisma-generator-typescript-interfaces" // Specifies the generator to create TypeScript interfaces for the Prisma schema.
  output   = "./dto/interfaces.ts"
}

datasource db {
  provider = "postgresql" // Default database provider is PostgreSQL. Adjust as needed.
  url      = env("DATABASE_URL")
}

// Enum for user profiles
enum ProfileName {
  CUSTOMER
  ADMIN
  PARTNER
}

// User model
model User {
  id                String        @id @default(uuid()) // Unique identifier
  username          String        @unique // Unique username
  email             String        @unique // Unique email
  profiles          ProfileName[] // Array of user profiles
  password          String // User's password
  email_verified_at DateTime? // Timestamp for email verification

  tokenFamilies TokenFamily[] // Relation to token families
  recipes       Recipe[] // Relation to recipes created by the user
  createdAt     DateTime      @default(now()) // Timestamp for creation
  updatedAt     DateTime      @updatedAt // Timestamp for last update

  // Stocks movements relations
  createdStockMovements  StockMovement[] @relation("CreatedStockMovements")
  approvedStockMovements StockMovement[] @relation("ApprovedStockMovements")
  executedStockMovements StockMovement[] @relation("ExecutedStockMovements")

  @@index([username, id, email]) // Compound index for fast lookups
}

// Enum for token status
enum TokenStatus {
  ACTIVE
  REVOKED
}

// Token family model for managing device-specific authentication
model TokenFamily {
  id Int @id @default(autoincrement())

  family        String         @unique // Unique family identifier
  deviceModel   String // User's device model
  ipAddress     String // IP address of the device
  userAgent     String // User agent string
  acceptLang    String // Accepted languages
  deviceType    String // Type of device
  deviceBrand   String // Brand of the device
  osName        String // Operating system name
  osVersion     String // Operating system version
  clientName    String // Client application name
  clientType    String // Type of client application
  clientVersion String // Version of the client application
  status        TokenStatus    @default(ACTIVE) // Status of the token
  createdAt     DateTime       @default(now()) // Creation timestamp
  updatedAt     DateTime       @updatedAt // Update timestamp
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade) // Relation to the user
  userId        String
  RefreshToken  RefreshToken[] // Related refresh tokens

  @@index([family, status, userId]) // Compound index
}

// Refresh token model for managing authentication sessions
model RefreshToken {
  id    Int    @id @default(autoincrement())
  token String @unique // Unique refresh token

  expiresAt DateTime // Expiration time of the token
  createdAt DateTime @default(now()) // Creation timestamp
  updatedAt DateTime @updatedAt // Update timestamp

  status TokenStatus @default(ACTIVE) // Status of the token

  family         TokenFamily    @relation(fields: [familyId], references: [id], onDelete: Cascade) // Relation to token family
  familyId       Int
  childrenTokens RefreshToken[] @relation("ChildrenTokens") // Child tokens (nested refresh tokens)
  parentToken    RefreshToken?  @relation("ChildrenTokens", fields: [parentTokenId], references: [id]) // Parent token
  parentTokenId  Int?

  @@index([status, token, parentTokenId, familyId]) // Compound index
}

// Model for product origins
model Origin {
  id      Int    @id @default(autoincrement())
  country String @unique // Unique country of origin

  createdAt DateTime  @default(now()) // Creation timestamp
  updatedAt DateTime  @updatedAt // Update timestamp
  products  Product[] // Related products
}

// Model for product categories
model ProductCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique // Unique category name
  description String? // Optional description
  imageRef    String? @unique // Reference to image file
  imageUrl    String? // URL to the image
  slug        String? // URL-friendly identifier

  Product Product[] // Related products

  createdAt DateTime @default(now()) // Creation timestamp
  updatedAt DateTime @updatedAt // Update timestamp
}

// Subcategory model for products
model ProductTag {
  id          Int     @id @default(autoincrement())
  name        String // Subcategory name
  description String? // Optional description

  imageRef String? @unique // Reference to image file
  imageUrl String? // URL to the image
  slug     String? // URL-friendly identifier

  ProductTagLinks ProductTagLink[] // Related Product Tag link
  createdAt       DateTime         @default(now()) // Creation timestamp
  updatedAt       DateTime         @updatedAt // Update timestamp

  @@unique([name]) // Unique constraint for category and name combination
}

model ProductTagLink {
  id           Int        @id @default(autoincrement())
  productId    String // reference to Product
  productTagId Int // reference to Product Tag
  product      Product    @relation(fields: [productId], references: [id]) // Related to the Product
  productTag   ProductTag @relation(fields: [productTagId], references: [id]) // Related TO ProductTag
  createdAt    DateTime   @default(now()) // Creation timestamp
  updatedAt    DateTime   @updatedAt // Update timestamp

  @@unique([productTagId, productId])
}

// Supplier model for product providers
model Supplier {
  id         Int       @id @default(autoincrement())
  name       String // Supplier name
  address1   String // Address line 1
  address2   String? // Optional address line 2
  city       String // City
  state      String? // Optional state or region
  postalCode String // Postal code
  country    String // Country
  imageRef   String?   @unique // Reference to image file
  products   Product[] // Related products

  createdAt DateTime @default(now()) // Creation timestamp
  updatedAt DateTime @updatedAt // Update timestamp

  @@unique([name, country, city, address1, postalCode]) // Unique constraint for identifying suppliers
}

// Model for margin levels applied to products
model MarginLevel {
  id       Int       @id @default(autoincrement())
  name     String    @unique // Unique margin level name
  margin   Float // Margin percentage
  products Product[] // Related products

  createdAt DateTime @default(now()) // Creation timestamp
  updatedAt DateTime @updatedAt // Update timestamp
}

// Model for units of measure
model UnitOfMeasure {
  id             Int     @id @default(autoincrement())
  name           String  @unique // Unique unit name
  type           UOMType // Type of unit (e.g., weight, volume)
  factor         Float   @default(1) // Conversion factor
  isStandard     Boolean @default(false) // Flag for standard units
  standardUnitId Int? // Reference to standard unit

  derivedUnitOfMeasures UnitOfMeasure[] @relation("StandardUnit") // Derived units
  standardUnit          UnitOfMeasure?  @relation("StandardUnit", fields: [standardUnitId], references: [id], onDelete: SetNull) // Relation to standard unit
  ingredients           Ingredient[] // Related ingredients

  createdAt         DateTime           @default(now()) // Creation timestamp
  updatedAt         DateTime           @updatedAt // Update timestamp
  volumeConversions VolumeConversion[] // Volume conversion relationships
}

enum VisibilityType {
  DRAFT
  VISIBLE
  HIDDEN
  ARCHIVED
}

// Product model
model Product {
  id String @id @default(uuid()) // Unique identifier

  name         String  @unique // Product name
  isGlutenFree Boolean // Indicates if the product is gluten-free
  isGMOFree    Boolean // Indicates if the product is GMO-free
  description  String? // Product description
  sku          String  @unique // Stock Keeping Unit

  isActive       Boolean        @default(false) // Indicates if the product is active
  isArchived     Boolean        @default(false) // Indicates if the product is archived
  visibility     VisibilityType @default(DRAFT)
  isFeatured     Boolean        @default(false) // Indicates if the product is featured
  additionalCost Float?         @default(0) // Additional cost

  costPerGramWhole   Float // Cost per gram (whole form)
  costPerGramGround  Float // Cost per gram (ground form)
  pricePerGramWhole  Float // Price per gram (whole form)
  pricePerGramGround Float // Price per gram (ground form)

  originId      Int // Reference to origin
  subcategoryId Int? // Optional reference to subcategory
  categoryId    Int // Reference to category
  supplierId    Int // Reference to supplier
  marginLevelId Int // Reference to margin level

  ingredients     Ingredient[] // Related ingredients in recipes
  productTagLinks ProductTagLink[] // Related Product Tag link
  inventory       Inventory?
  // Media
  images          ProductImage[]
  stockMovements  StockMovement[] // Related stock movements

  origin Origin @relation(fields: [originId], references: [id]) // Relation to origin

  category ProductCategory @relation(fields: [categoryId], references: [id]) // Relation to category
  supplier Supplier        @relation(fields: [supplierId], references: [id]) // Relation to supplier

  marginLevel      MarginLevel       @relation(fields: [marginLevelId], references: [id]) // Relation to margin level
  createdAt        DateTime          @default(now()) // Creation timestamp
  updatedAt        DateTime          @updatedAt // Update timestamp
  volumeConversion VolumeConversion? // Relation to volume conversion
}

model ProductImage {
  id         String  @id @default(uuid())
  url        String
  altText    String?
  isFeatured Boolean @default(false)
  sortOrder  Int     @default(0)
  productId  String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// Improved Inventory model
model Inventory {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stock information
  quantity          Float @default(0) // Total quantity in stock
  availableQuantity Float @default(0) // Accounts for reserved items
  reservedQuantity  Float @default(0) // Items in carts or pending orders

  // Added attributes
  minimumQuantity       Float  @default(0) // Minimum quantity to keep in stock
  maximumQuantity       Float? // Maximum quantity to keep (optional, for storage limits)
  safetyStockLevel      Float  @default(0) // Buffer stock to prevent stockouts
  economicOrderQuantity Float? // Optimal order quantity based on costs

  // Cost and valuation
  unitCost        Float? // Current unit cost of the inventory
  totalValue      Float? // Total value of inventory (quantity * unitCost)
  valuationMethod ValuationMethod @default(WAC) // Method used for inventory valuation

  // Reorder information
  reorderThreshold Float @default(5) // When to reorder
  reorderQuantity  Float @default(10) // How much to reorder
  leadTimeInDays   Int? // Expected days between order and receipt

  // Stock status
  inStock       Boolean @default(true) // Is the item in stock?
  backOrderable Boolean @default(false) // Can be back-ordered?
  isActive      Boolean @default(true) // Is this inventory active?

  // Stock tracking
  lastStockCheck     DateTime? // Last physical inventory check
  nextScheduledCheck DateTime? // Next scheduled check
  lastReceivedDate   DateTime? // Date when last received stock
  expiryDate         DateTime? // Expiration date if applicable

  // Additional attributes
  stockLocation String? // Specific location within warehouse (e.g., "Aisle 5, Bin 3")
  notes         String? // General notes about this inventory
  turnoverRate  Float? // Historical turnover rate

  // Relationships
  productId String  @unique // Reference to product
  product   Product @relation(fields: [productId], references: [id])

  warehouseId String // Reference to warehouse
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  // Stock movements
  stockMovements StockMovement[] // Relation to stock movements

  @@index([productId, warehouseId]) // Index for fast lookup by product and warehouse
  @@index([inStock, isActive]) // Index for status lookup
}

model Warehouse {
  id          String      @id @default(uuid())
  name        String      @unique
  location    String?
  isDefault   Boolean     @default(false)
  inventories Inventory[]

  // Added attributes for warehouses
  address    String?
  city       String?
  postalCode String?
  country    String?
  capacity   Float? // Storage capacity 
  isActive   Boolean @default(true)

  // Relationships for source/destination in stock movements
  sourceMovements      StockMovement[] @relation("SourceWarehouse")
  destinationMovements StockMovement[] @relation("DestinationWarehouse")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Enhanced StockMovement model
model StockMovement {
  id        String @id @default(uuid())
  reference String @unique // Reference number for tracking

  // Movement details
  quantity   Float // Changed from Int to Float for partial quantities
  unitCost   Float? // Cost per unit at time of movement
  totalValue Float? // Total value of the movement (quantity * unitCost)

  // Expanded type and reason fields
  movementType MovementType
  reason       MovementReason
  status       MovementStatus @default(DRAFT)

  // Traceability
  lotNumber    String? // Lot/batch number for tracking
  expiryDate   DateTime? // Expiration date for perishable items
  batchId      String? // Group ID for related movements
  isAdjustment Boolean   @default(false) // Whether this is an inventory adjustment

  // Document references
  documentNumber String? // Reference document (invoice, PO, etc.)
  notes          String? // Additional information
  metadata       Json? // Flexible JSON field for additional data

  // Temporal data
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  scheduledAt DateTime? // When movement is scheduled to occur
  executedAt  DateTime? // When movement actually occurred
  deletedAt   DateTime? // For soft delete
  version     Int       @default(0) // For optimistic concurrency control

  // Relationships - main entities
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  productId   String
  product     Product   @relation(fields: [productId], references: [id])

  // Relationships - warehouses
  sourceWarehouseId      String?
  sourceWarehouse        Warehouse? @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id])
  destinationWarehouseId String?
  destinationWarehouse   Warehouse? @relation("DestinationWarehouse", fields: [destinationWarehouseId], references: [id])

  // Relationships - users
  createdById  String
  createdBy    User    @relation("CreatedStockMovements", fields: [createdById], references: [id])
  approvedById String?
  approvedBy   User?   @relation("ApprovedStockMovements", fields: [approvedById], references: [id])
  executedById String?
  executedBy   User?   @relation("ExecutedStockMovements", fields: [executedById], references: [id])

  // Hierarchical relationships
  parentMovementId String?
  parentMovement   StockMovement?  @relation("MovementRelation", fields: [parentMovementId], references: [id])
  childMovements   StockMovement[] @relation("MovementRelation")

  // Indexes for performance
  @@index([productId])
  @@index([inventoryId])
  @@index([movementType])
  @@index([status])
  @@index([createdAt])
  @@index([scheduledAt])
  @@index([executedAt])
  @@index([sourceWarehouseId])
  @@index([destinationWarehouseId])
  @@index([lotNumber])
  @@index([batchId])
}

// Enhanced enums for stock movement
enum MovementType {
  INCOMING // Stock arriving in the system
  OUTGOING // Stock leaving the system
  TRANSFER // Stock moving between locations
  ADJUSTMENT // Correction of inventory discrepancies
  RETURN // Customer returns
}

enum MovementReason {
  PURCHASE // Bought from supplier
  SALE // Sold to customer
  TRANSFER // Moving between locations
  ADJUSTMENT_INVENTORY // Reconciliation after count
  ADJUSTMENT_DAMAGE // Write-off due to damage
  ADJUSTMENT_EXPIRY // Write-off due to expiration
  RETURN_FROM_CUSTOMER // Customer returned product
  RETURN_TO_SUPPLIER // Returning to supplier
  PRODUCTION // Used in production process
  CONSUMPTION // Used internally
  ORDER // For customer order
  PURCHASE_ORDER // For supplier order
  INVENTORY // From inventory check
  OTHER // Miscellaneous reason
}

enum MovementStatus {
  DRAFT // Initially created
  PLANNED // Scheduled for future
  IN_PROGRESS // Currently being processed
  COMPLETED // Fully processed
  CANCELLED // Cancelled movement
}

enum ValuationMethod {
  FIFO // First In, First Out
  LIFO // Last In, First Out
  WAC // Weighted Average Cost
  FEFO // First Expired, First Out (for perishables)
}

// Enumeration for unit of measure types
enum UOMType {
  WEIGHT
  VOLUME
  OTHER
}

// Recipe model
model RecipeCategory {
  id          Int                  @id @default(autoincrement())
  name        String               @unique // Unique category name
  imageRef    String?              @unique // Reference to image file
  imageUrl    String? // URL to the image
  slug        String? // URL-friendly identifier
  description String? // Optional description
  recipes     RecipeCategoryLink[] // Many-to-many relationship with recipes
  createdAt   DateTime             @default(now()) // Creation timestamp
  updatedAt   DateTime             @updatedAt // Update timestamp
}

model RecipeCategoryLink {
  id         Int @id @default(autoincrement())
  recipeId   Int // Reference to recipe
  categoryId Int // Reference to category

  recipe    Recipe         @relation(fields: [recipeId], references: [id]) // Relation to recipe
  category  RecipeCategory @relation(fields: [categoryId], references: [id]) // Relation to category
  createdAt DateTime       @default(now()) // Creation timestamp
  updatedAt DateTime       @updatedAt // Update timestamp

  @@unique([recipeId, categoryId]) // Unique constraint for recipe-category pairs
}

// Enumeration for recipe difficulty levels
enum RecipeDifficultyType {
  EASY
  MEDIUM
  HARD
}

// Main recipe model
model Recipe {
  id              Int                  @id @default(autoincrement())
  name            String               @unique // Unique recipe name
  description     String? // Optional description
  preparationTime Int // Preparation time in minutes
  cookingTime     Int? // Cooking time in minutes
  servings        Int? // Number of servings
  isApproved      Boolean              @default(false) // Approval status
  isPromoAwarded  Boolean              @default(false) // Promo status
  difficulty      RecipeDifficultyType @default(EASY) // Difficulty level
  visibility      VisibilityType       @default(DRAFT)
  userId          String // Reference to author
  categories      RecipeCategoryLink[] // Many-to-many relationship with categories
  ingredients     Ingredient[] // Relation to ingredients
  steps           Step[] // Relation to recipe steps
  author          User                 @relation(fields: [userId], references: [id]) // Relation to author
  createdAt       DateTime             @default(now()) // Creation timestamp
  updatedAt       DateTime             @updatedAt // Update timestamp
}

// Ingredient model for recipes
model Ingredient {
  id            Int     @id @default(autoincrement())
  name          String?
  quantity      Float // Quantity required
  grindRequired Boolean // Indicates if grinding is required

  recipeId        Int // Reference to recipe
  productId       String? // Reference to product
  unitOfMeasureId Int // Reference to unit of measure
  unitOfMeasure   UnitOfMeasure @relation(fields: [unitOfMeasureId], references: [id]) // Relation to unit of measure
  product         Product?      @relation(fields: [productId], references: [id]) // Relation to product
  recipe          Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade) // Relation to recipe
  createdAt       DateTime      @default(now()) // Creation timestamp
  updatedAt       DateTime      @updatedAt // Update timestamp

  @@unique([recipeId, productId]) // Unique constraint for recipe-product pairs
  @@unique([recipeId, name])
}

// Model for recipe steps
model Step {
  id          Int    @id @default(autoincrement())
  recipeId    Int // Reference to recipe
  stepNumber  Int // Step number
  description String // Description of the step
  duration    Int? // Optional duration in minutes

  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade) // Relation to recipe
  createdAt DateTime @default(now()) // Creation timestamp
  updatedAt DateTime @updatedAt // Update timestamp
}

// Model for volume conversion
model VolumeConversion {
  id        Int           @id @default(autoincrement())
  m1        Float // Conversion factor 1
  m2        Float // Conversion factor 2
  m3        Float // Conversion factor 3
  avg       Float // Average conversion factor
  productId String        @unique // Reference to product
  stdVolId  Int // Reference to standard volume
  stdVol    UnitOfMeasure @relation(fields: [stdVolId], references: [id]) // Relation to standard volume
  product   Product       @relation(fields: [productId], references: [id]) // Relation to product
  createdAt DateTime      @default(now()) // Creation timestamp
  updatedAt DateTime      @updatedAt // Update timestamp
}
